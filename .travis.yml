language: groovy
sudo: required
services: docker

on: [push, pull_request]

addons:
    apt:
        packages:
            ant

jobs: 
    test:
        env:
            NXF_VER: ${{ matrix.nxf_ver }}
            NXF_ANSI_LOG: false
        
        runs-on: ubuntu-latest
                
        strategy: 
            matrix:
                nxf_ver: ['19.10.0', '']
                    
        steps:
            - name: Install Nextflow
              run: |
                echo "Installing Nextflow"
                wget -qO- https://get.nextflow.io | bash
                sudo mv nextflow /usr/local/bin

            - name: Build Docker Image
              run : |
                echo "Build docker image"
                docker build . --file ./Dockerfile --tag variantcalling

            #- name: Pull Docker Image
            #  run : | 
            #    echo "Pull Docker Image"
            #    docker pull daviesdrew/pipelines:variantcalling
            #    docker tag daviesdrew/pipelines:variantcalling daviesdrew/pipelines:variantcalling
                
            - name: Run Pipeline With Test Data
              run : | 
                echo ${GITHUB_WORKSPACE}
                nextflow run main.nf -profile test -with-docker variantcalling:latest --fastp_min_base_quality 15 --fastp_max_percent_low_qual_base 40 

        after_success:
            - echo "CI build of variantcalling pipeline succeeded"

     
        after_failure: 
            - echo "CI build of variantcalling pipeline failed"
